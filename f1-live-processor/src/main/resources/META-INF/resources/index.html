<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 live timing storage processor</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container-fluid p-5 bg-primary text-white text-center">
    <h1>Status</h1>
    <p>F1 live timing storage processor status</p>
    <p>Last updated: <span id="last-updated">Not updated</span></p>
</div>

<div class="container mt-5">
        <div class="row">
        <div class="col-sm-12">
            <h3 class="text-lg font-bold text-center">Messages</h3>
            <p>SSE connection status: <span id="sse-connection-status">Not connected</span></p>
            <div id="live-timing-messages-container" class="text-sm"></div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script>
    const messages = new Array();
    let lastMessageUpdate = Temporal.NOW.instant();

    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        document.getElementById('last-updated').textContent = new Date().toLocaleString();
    });

    function fetchData() {
        // Create a new EventSource object, pointing to your server endpoint
        console.log("Connecting to status SSE endpoint...")
        const statusElement = document.getElementById('sse-connection-status');
        statusElement.textContent = "Connecting...";

        const eventSource = new EventSource("/status");

        // Add an event listener for generic 'message' events
        eventSource.onmessage = function(event) {
            console.log("Received a message:", event.data);
            addMessage(event.data);
            // event.data contains the message payload as a string
        };

        eventSource.addEventListener('status', function(event) {
            console.log("Received status event:", event.data);
            addMessage(event.data);
        });


        // Listen for the "open" event when the connection is established
        eventSource.onopen = function(event) {
            const statusElement = document.getElementById('sse-connection-status');
            statusElement.textContent = "Connected";
            console.log("Connection opened");
        };

        // Listen for "error" events
        eventSource.onerror = function(error) {
            const statusElement = document.getElementById('sse-connection-status');
            statusElement.textContent = "Error or Disconnected";
            console.error("EventSource error:", error);
            // Automatic reconnection is built-in to the EventSource API
        };
    }

    function addMessage(message) {
        const record = {
            date: new Date(),
            message: message,
            messageShort: message
        }
        messages.push(record);

        if (messages.length >= 20) {
            messages.shift();
        }


    }

    function updateLiveTimingMessages(messages) {
      const tableContainer = document.getElementById('live-timing-messages-container');

      // Clear any existing content
      tableContainer.innerHTML = '';

      // Create the table element
      const table = document.createElement('table');
      table.classList.add('table', 'table-striped', 'table-hover', 'w-full', 'border', 'border-collapse');

      // Create the table header (thead)
      const thead = table.createTHead();
      const headerRow = thead.insertRow();

      // Define headers
      const headers = ["Timestamp", "Category", "Message Text"];
      headers.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        th.classList.add('px-4', 'py-2', 'bg-gray-200', 'font-bold', 'text-left');
        headerRow.appendChild(th);
      });

      // Create the table body (tbody)
      const tbody = table.createTBody();

      // Populate the table with message data
      messages.forEach(message => {
        const row = tbody.insertRow();
        row.classList.add('border-t', 'border-gray-300');

        // Add cells for timestamp, category, and message text
        const timestampCell = row.insertCell();
        timestampCell.textContent = message.date.toLocaleString();
        timestampCell.classList.add('px-4', 'py-2');

        const categoryCell = row.insertCell();
        categoryCell.textContent = "status";
        // Add conditional styling based on category
        if (message.category === "Error") {
          categoryCell.classList.add('font-semibold', 'text-red-600');
        } else if (message.category === "Warning") {
          categoryCell.classList.add('font-semibold', 'text-yellow-600');
        } else if (message.category === "Info") {
          categoryCell.classList.add('font-semibold', 'text-green-600');
        }
        categoryCell.classList.add('px-4', 'py-2');

        const messageCell = row.insertCell();
        messageCell.textContent = message.messageShort;
        messageCell.classList.add('px-4', 'py-2');

        // Add click event listener to each row
        row.addEventListener('click', () => {
          const modalBody = document.getElementById('modal-full-text');
          modalBody.textContent = message.message;

          const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
          messageModal.show();
        });
      });

      // Append the completed table to the container
      tableContainer.appendChild(table);
    }

</script>
</body>
</html>